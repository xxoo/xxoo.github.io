"use strict";define(["module","common/kernel/kernel","common/chart/chart"],function(e,t,n){var o,a,s=e.id.replace(/^[^/]+\/|\/[^/]+/g,""),r=document.querySelector("#page>."+s),c=new n(r.querySelector(".chart"),!0),u=new n(r.querySelector(".subchart"),!1,!0),l="https://trade.tinysoft.com.cn/webapi/api2.tsl",i=[{},{},{}],d={},f=r.querySelector(".list>.name"),h=r.querySelector(".list>.canvas>canvas").getContext("2d"),v=r.querySelector(".list>span");return u.labeling=function(e,t){return t?Math.round(1e3*e)/10+"%":new Date(R(a[e])).toISOString().replace(/T.*$/,"")},c.labeling=function(e,t){return t?Math.round(d[c.selected].data[e]/d[c.selected].rate*100)/100:new Date(R(a[e+d[c.selected].offset])).toISOString().replace(/T.*$/,"")},c.onrangechange=function(){if(c.selected){var e=c.cross-d[c.selected].cross-d[c.selected].offset;u.setRange(c.begin-e,c.end-e)}},h.canvas.width=1,h.canvas.addEventListener("mousedown",function b(e){0===e.button&&o.length&&(h.canvas.removeEventListener("mousedown",b),h.canvas.addEventListener("mousemove",t),document.addEventListener("mouseup",function n(e){0===e.button&&(h.canvas.addEventListener("mousedown",b),h.canvas.removeEventListener("mousemove",t),document.removeEventListener("mouseup",n))}),t(e));function t(e){e.offsetY>=0&&e.offsetY<=h.canvas.offsetHeight&&y(e.offsetY)}}),h.canvas.addEventListener("keydown",function(e){if(c.selected&&(38===e.keyCode||40===e.keyCode)){e.preventDefault();var t=o.indexOf(c.selected);38===e.keyCode?t>0&&y(this.offsetHeight*(t-1)/(o.length-1)):t<o.length-1&&y(this.offsetHeight*(t+1)/(o.length-1))}}),{onload:function(e){e?(t.showLoading(),Promise.all([fetch(l,{method:"post",body:"ServiceID=Z002"}).then(function(e){return e.json()}),fetch(l,{method:"post",body:"ServiceID=Z003&param=["+encodeURIComponent('"Aè‚¡"')+"]"}).then(function(e){return e.json()}).then(function(e){var t=e.Result;return caches.open("chart").then(function(e){return e.match("/data").then(function(n){return n?n.json().then(function(n){return fetch(l,{method:"post",body:'ServiceID=Z001&param=["'+Object.keys(t).join(";")+'",'+n.days[n.days.length-1]+"]"}).then(function(e){return e.json()}).then(function(o){for(var a=1;a<o.Result.length;a++){a>1&&n.days.push(o.Result[a][0]);for(var s=1;s<o.Result[a].length;s++)null!==o.Result[a][s]&&(n.base[o.Result[0][s]]||(n.base[o.Result[0][s]]=[t[o.Result[0][s]],n.days.length-1]),1===a&&n.base[o.Result[0][s]].length>2?n.base[o.Result[0][s]].splice(-1,1,o.Result[a][s]):n.base[o.Result[0][s]].push(o.Result[a][s]))}return o.Result.length>2&&e.put("/data",new Response(JSON.stringify(n))),n})}):fetch(l,{method:"post",body:'ServiceID=Z001&param=["'+Object.keys(t).join(";")+'"]'}).then(function(e){return e.json()}).then(function(n){for(var o={days:[],base:{}},a=1;a<n.Result.length;a++){for(var s=1;s<n.Result[a].length;s++)null!==n.Result[a][s]&&(o.base[n.Result[0][s]]||(o.base[n.Result[0][s]]=[t[n.Result[0][s]],o.days.length]),o.base[n.Result[0][s]].push(n.Result[a][s]));o.days.push(n.Result[a][0])}return e.put("/data",new Response(JSON.stringify(o))),o})})})})]).then(function(e){a=e[1].days;var n=e[0].Result,o=e[1].base,s=Object.keys(n),r=[[.25,1,.25,.75],[.25,.25,.25,.75],[1,.25,.25,.75]],l={0:{data:Array(a.length).fill(0),colors:[r[0]]},1:{data:Array(a.length).fill(0),colors:[r[1]]},2:{data:Array(a.length).fill(0),colors:[r[2]]}};s.sort(function(e,t){var n=o[e],a=o[t];return a[a.length-1][2]-n[n.length-1][2]});for(var f=0;f<s.length;f++){var h=a.indexOf(n[s[f]][0]),v=o[s[f]],p=void 0;if(h>=0){d[s[f]]={data:[],cross:h-v[1],name:v[0],offset:v[1],colors:[]};for(var y=2;y<v.length;y++)l[v[y][3]].data[y+v[1]-2]++,p!==v[y][3]&&(p=v[y][3],d[s[f]].colors[d[s[f]].data.length]=r[v[y][3]]),d[s[f]].data.push(v[y][0]*v[y][1]),y===v.length-1&&(i[v[y][3]][s[f]]=!0,d[s[f]].color=m(v[y][2]),d[s[f]].rate=v[y][1])}}for(var R=0;R<a.length;R++){var b=l[0].data[R]+l[1].data[R]+l[2].data[R];l[0].data[R]/=b,l[1].data[R]/=b,l[2].data[R]/=b}c.clear(),c.setData(d),u.clear(),u.setData(l),g(),t.hideLoading()})):g()}};function g(){var e={};if(t.location.args.c>=0&&t.location.args.c<i.length){for(var n in d)e[n]=i[t.location.args.c][n];u.selected=t.location.args.c,o=Object.keys(i[t.location.args.c])}else{for(var a in d)e[a]=!0;u.selected=undefined,o=Object.keys(d)}c.setVisibility(e),c.cursor=c.cross,c.center(),h.clearRect(0,0,1,h.canvas.height),h.canvas.height=o.length;for(var s=0;s<o.length;s++)h.fillStyle=d[o[s]].color,h.fillRect(0,s,1,1);y(0)}function m(e){return"rgb("+t(e)+","+t(1-e)+","+t(e>.5?1-e:e)+")";function t(e){return Math.round(255*e)}}function p(e){if(e.button===0&&o.length){h.canvas.removeEventListener("mousedown",p);h.canvas.addEventListener("mousemove",t);document.addEventListener("mouseup",n);t(e)}function t(e){if(e.offsetY>=0&&e.offsetY<=h.canvas.offsetHeight){y(e.offsetY)}}function n(e){if(e.button===0){h.canvas.addEventListener("mousedown",p);h.canvas.removeEventListener("mousemove",t);document.removeEventListener("mouseup",n)}}}function y(e){v.style.top=36.5+e+"px",c.selected=o[Math.round(e/h.canvas.offsetHeight*(o.length-1))],f.innerHTML=d[c.selected].name+"<span>"+c.selected+"</span>",c.onrangechange()}function R(e){return Math.round(864e5*e)-2209190743e3}});